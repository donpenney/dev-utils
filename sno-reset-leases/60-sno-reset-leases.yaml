apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 60-sno-reset-leases
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKIwojIFJ1biBhIGxvY2FsIGV0Y2Qgc2VydmVyIGFuZCBkZWxldGUgYWxsIHRoZSBsZWFkZXIgbGVhc2VzCiMKClBST0c9JChiYXNlbmFtZSAiJDAiKQoKZnVuY3Rpb24gbG9nIHsKICAgIGVjaG8gIiR7UFJPR306ICQqIgp9CgpmdW5jdGlvbiBjbGVhbnVwIHsKICAgIGlmICEgcG9kbWFuIGNvbnRhaW5lciBleGlzdHMgbG9jYWxfZXRjZDsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKCiAgICAjIFN0b3AgdGhlIGxvY2FsX2V0Y2QKICAgIGxvZyAiU2h1dHRpbmcgZG93biBsb2NhbF9ldGNkIgogICAgaWYgISBwb2RtYW4gc3RvcCBsb2NhbF9ldGNkIDsgdGhlbgogICAgICAgIGxvZyAiRmFpbGVkIHRvIHN0b3AgbG9jYWxfZXRjZC4gS2lsbGluZyBjb250YWluZXIiCiAgICAgICAgaWYgISBwb2RtYW4ga2lsbCBsb2NhbF9ldGNkIDsgdGhlbgogICAgICAgICAgICBsb2cgIkZhaWxlZCB0byBraWxsIGxvY2FsX2V0Y2QiCiAgICAgICAgICAgIGV4aXQgMQogICAgICAgIGZpCiAgICBmaQp9Cgp0cmFwIGNsZWFudXAgRVhJVAoKZnVuY3Rpb24gY2x1c3RlcklzU05PIHsKICAgIGxvY2FsIGpzb249CiAgICBsb2NhbCBjb250cm9sUGxhbmVUb3BvbG9neT0KICAgIGxvY2FsIGluZnJhc3RydWN0dXJlVG9wb2xvZ3k9CiAgICBsb2NhbCBjbHVzdGVyQ1I9Ii9rdWJlcm5ldGVzLmlvL2NvbmZpZy5vcGVuc2hpZnQuaW8vaW5mcmFzdHJ1Y3R1cmVzL2NsdXN0ZXIiCiAgICBqc29uPSQocG9kbWFuIGV4ZWMgbG9jYWxfZXRjZCBldGNkY3RsIGdldCAiJHtjbHVzdGVyQ1J9IiAtLXByaW50LXZhbHVlLW9ubHkpCiAgICBjb250cm9sUGxhbmVUb3BvbG9neT0kKGVjaG8gIiR7anNvbn0iIHwganEgLXIgJy5zdGF0dXMuY29udHJvbFBsYW5lVG9wb2xvZ3knKQogICAgaW5mcmFzdHJ1Y3R1cmVUb3BvbG9neT0kKGVjaG8gIiR7anNvbn0iIHwganEgLXIgJy5zdGF0dXMuaW5mcmFzdHJ1Y3R1cmVUb3BvbG9neScpCgogICAgaWYgWyAiJHtjb250cm9sUGxhbmVUb3BvbG9neX0iICE9ICJTaW5nbGVSZXBsaWNhIiBdIHx8IFsgIiR7aW5mcmFzdHJ1Y3R1cmVUb3BvbG9neX0iICE9ICJTaW5nbGVSZXBsaWNhIiBdOyB0aGVuCiAgICAgICAgbG9nICJDbHVzdGVyIGlzIG5vdCBTTk86IGNvbnRyb2xQbGFuZVRvcG9sb2d5PSR7Y29udHJvbFBsYW5lVG9wb2xvZ3l9LCBpbmZyYXN0cnVjdHVyZVRvcG9sb2d5PSR7aW5mcmFzdHJ1Y3R1cmVUb3BvbG9neX0iCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgcmV0dXJuIDAKfQoKZnVuY3Rpb24gbGNhTmFtZXNwYWNlRXhpc3RzIHsKICAgIGxvY2FsIGxjYU5zPSIva3ViZXJuZXRlcy5pby9uYW1lc3BhY2VzL29wZW5zaGlmdC1saWZlY3ljbGUtYWdlbnQiCiAgICBbICIkKHBvZG1hbiBleGVjIGxvY2FsX2V0Y2QgZXRjZGN0bCBnZXQgJHtsY2FOc30gLS1rZXlzLW9ubHkpIiA9ICIke2xjYU5zfSIgXQp9CgpmdW5jdGlvbiBkZWxldGVLZXkgewogICAgbG9jYWwga2V5PSIkMSIKICAgIGlmIFsgIiQocG9kbWFuIGV4ZWMgbG9jYWxfZXRjZCBldGNkY3RsIGdldCAke2tleX0gLS1rZXlzLW9ubHkpIiA9ICIke2tleX0iIF07IHRoZW4KICAgICAgICBsb2cgIkRlbGV0aW5nICR7a2V5fSIKICAgICAgICBwb2RtYW4gZXhlYyBsb2NhbF9ldGNkIGV0Y2RjdGwgZGVsICIke2tleX0iCiAgICBmaQp9CgpzZXQgLXgKCk1BTklGRVNUPS9ldGMva3ViZXJuZXRlcy9tYW5pZmVzdHMvZXRjZC1wb2QueWFtbAppZiBbICEgLWYgIiR7TUFOSUZFU1R9IiBdOyB0aGVuCiAgICBsb2cgIlN0YXRpYyBwb2QgbWFuaWZlc3Qgbm90IGZvdW5kOiAke01BTklGRVNUfSIKICAgIGV4aXQgMQpmaQoKIyBGaW5kIHRoZSBldGNkIGltYWdlIGZyb20gdGhlIHN0YXRpYyBwb2QgbWFuaWZlc3QKRVRDRF9JTUFHRT0kKGpxIC1yICcuc3BlYy5jb250YWluZXJzW10gfCBzZWxlY3QoLm5hbWUgPT0gImV0Y2QiKSB8IC5pbWFnZScgPCR7TUFOSUZFU1R9KQppZiBbIC16ICIke0VUQ0RfSU1BR0V9IiBdOyB0aGVuCiAgICBsb2cgIlVuYWJsZSB0byBkZXRlcm1pbmUgZXRjZCBpbWFnZSBmcm9tIHN0YXRpYyBwb2QgbWFuaWZlc3QiCiAgICBleGl0IDEKZmkKCiMgTGF1bmNoIGxvY2FsIGV0Y2QKbG9nICJMYXVuY2hpbmcgbG9jYWxfZXRjZCBjb250YWluZXIiCmlmICEgcG9kbWFuIHJ1biAtLW5hbWUgbG9jYWxfZXRjZCAtLXJtIC0tcmVwbGFjZSAtLWRldGFjaCAtLXByaXZpbGVnZWQgXAogICAgLS1lbnRyeXBvaW50IGV0Y2QgLXYgL3Zhci9saWIvZXRjZDovc3RvcmUgXAogICAgIiR7RVRDRF9JTUFHRX0iIC0tbmFtZSBlZGl0b3IgLS1kYXRhLWRpciAvc3RvcmUgOyB0aGVuCiAgICBsb2cgIlVuYWJsZSB0byBydW4gbG9jYWxfZXRjZCBjb250YWluZXIiCiAgICBleGl0IDEKZmkKCiMgRXhpdCB3aXRob3V0IG1ha2luZyBjaGFuZ2VzLCBpZiBub3QgU05PCmlmICEgY2x1c3RlcklzU05POyB0aGVuCiAgICBsb2cgIkNsdXN0ZXIgaXMgbm90IFNOTy4gRXhpdGluZyB3aXRob3V0IGNoYW5nZXMiCiAgICBleGl0IDAKZmkKCiMgRXhpdCB3aXRob3V0IG1ha2luZyBjaGFuZ2VzLCBpZiBubyBMQ0EKaWYgISBsY2FOYW1lc3BhY2VFeGlzdHM7IHRoZW4KICAgIGxvZyAiTENBIGlzIG5vdCBpbnN0YWxsZWQuIEV4aXRpbmcgd2l0aG91dCBjaGFuZ2VzIgogICAgZXhpdCAwCmZpCgojIERlbGV0ZSBhbGwgbGVhc2VzCmxvZyAiRGVsZXRpbmcgbGVhc2VzIgppZiAhIHBvZG1hbiBleGVjIGxvY2FsX2V0Y2QgZXRjZGN0bCBkZWwgLS1wcmVmaXggL2t1YmVybmV0ZXMuaW8vbGVhc2VzLyAtLWNvbW1hbmQtdGltZW91dD02MHMgOyB0aGVuCiAgICBsb2cgIkZhaWxlZCB0byBkZWxldGUgbGVhc2VzIgogICAgZXhpdCAxCmZpCgojIEluIDQuMTQsIHRoZXJlIGFyZSBzb21lIHBvZHMgdXNpbmcgY29uZmlnbWFwIGxvY2tzLCByYXRoZXIgdGhhbiBsZWFzZSBsb2NrcywgZm9yIGxlYWRlciBlbGVjdGlvbi4KIyBEZWxldGUgdGhlc2Ugc3BlY2lmaWMgZW50cmllcywgaWYgdGhleSBleGlzdApkZWxldGVLZXkgIi9rdWJlcm5ldGVzLmlvL2NvbmZpZ21hcHMvb3BlbnNoaWZ0LWNsb3VkLWNyZWRlbnRpYWwtb3BlcmF0b3IvY2xvdWQtY3JlZGVudGlhbC1vcGVyYXRvci1sZWFkZXIiCmRlbGV0ZUtleSAiL2t1YmVybmV0ZXMuaW8vY29uZmlnbWFwcy9vcGVuc2hpZnQtY2x1c3Rlci12ZXJzaW9uL3ZlcnNpb24iCmRlbGV0ZUtleSAiL2t1YmVybmV0ZXMuaW8vY29uZmlnbWFwcy9vcGVuc2hpZnQtY29udHJvbGxlci1tYW5hZ2VyL29wZW5zaGlmdC1tYXN0ZXItY29udHJvbGxlcnMiCmRlbGV0ZUtleSAiL2t1YmVybmV0ZXMuaW8vY29uZmlnbWFwcy9vcGVuc2hpZnQtbWFya2V0cGxhY2UvbWFya2V0cGxhY2Utb3BlcmF0b3ItbG9jayIKCiMgRW5zdXJlIC9ldGMvZG9ja2VyL2NlcnRzLmQgZXhpc3RzLCB0byBhdm9pZCBNQ1AgZGVncmFkYXRpb24gaXNzdWUKaWYgWyAhIC1kIC9ldGMvZG9ja2VyL2NlcnRzLmQgXTsgdGhlbgogICAgbWtkaXIgLXAgL2V0Yy9kb2NrZXIvY2VydHMuZApmaQoKZXhpdCAwCgo=
          mode: 365
          path: /usr/local/bin/sno-reset-leases.sh
    systemd:
      units:
        - name: sno-reset-leases.service
          enabled: true
          contents: |
            [Unit]
            Description=SNO Lease reset
            After=NetworkManager-wait-online.service
            Before=ovs-configuration.service kubelet-dependencies.target kubelet.service

            [Service]
            Type=oneshot
            RemainAfterExit=no
            ExecStart=/usr/local/bin/sno-reset-leases.sh

            [Install]
            WantedBy=multi-user.target
